@using System.Security.Claims
@model Chat.Core.Entities.ChatSession

@{
    Layout = "_Layout";
    ViewData["Title"] = "الدعم المباشر";

    // استخدام الطريقة الصحيحة للحصول على userId
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var userName = User.Identity?.Name ?? "مستخدم";

    // التحقق من القيم
    bool isClosed = ViewBag.IsClosed != null && (bool)ViewBag.IsClosed;
}


<div class="chat-container">
    <!-- شريط معلومات الدردشة -->
    <div class="chat-header bg-primary text-white p-3 rounded-top">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-headset fa-lg me-3"></i>
                <div>
                    <h4 class="mb-0">الدعم المباشر</h4>
                    <small id="connectionStatus" class="d-block">جاري الاتصال...</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark">
                    <i class="fas fa-hashtag"></i> @Model.Id
                </span>
                <button id="btnEndChat" class="btn btn-sm btn-outline-light" title="إنهاء المحادثة">
                    <i class="fas fa-times me-1"></i> إنهاء
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة -->
    <div id="chatBox" class="chat-messages p-3">
        <!-- الرسائل ستظهر هنا ديناميكيًا -->
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin me-2"></i> جاري الاتصال بالدعم...
        </div>
    </div>

    <!-- منطقة الكتابة -->
    <div class="chat-input p-3 border-top">
        <div class="input-group">
            <input type="text" id="msgInput" class="form-control"
                   placeholder="اكتب رسالتك هنا (حد أقصى 500 حرف)..."
                   autocomplete="off"
                   maxlength="500"
                   @(isClosed ? "disabled" : "")>
            <button id="btnSend" class="btn btn-primary" @(isClosed ? "disabled" : "")>
                <i class="fas fa-paper-plane"></i> إرسال
            </button>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">
                <i class="fas fa-user me-1"></i> أنت: @userName
            </small>
            <div>
                <small id="charCount" class="text-muted">0/500</small>
                <small id="typingIndicator" class="text-muted ms-2" style="display:none;">
                    <i class="fas fa-pencil-alt me-1"></i> الدعم يكتب...
                </small>
            </div>
        </div>
        <div class="alert alert-warning alert-dismissible fade show mt-2" id="charLimitAlert" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="alertMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>



<style>
    .chat-container {
        max-width: 500px; /* أصغر عرض */
        margin: 1rem auto;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        background: white;
        height: 85vh; /* ارتفاع مناسب */
        max-height: 700px;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        flex-shrink: 0;
        padding: 12px 15px !important;
        background: linear-gradient(135deg, #0069d9, #0056b3) !important;
    }

    .chat-messages {
        flex: 1;
        height: auto;
        min-height: 0;
        overflow-y: auto;
        background: #f0f2f5;
        padding: 10px 15px !important;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    /* رسائل المرسل */
    .message-sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #0084ff, #0073e6);
        color: white;
        border-radius: 18px 18px 4px 18px;
        padding: 8px 12px;
        max-width: 80%;
        min-width: 50px;
        margin: 2px 0;
        animation: slideInRight 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    /* رسائل المستقبل */
    .message-received {
        align-self: flex-start;
        background: white;
        color: #333;
        border-radius: 18px 18px 18px 4px;
        padding: 8px 12px;
        max-width: 80%;
        min-width: 50px;
        margin: 2px 0;
        animation: slideInLeft 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        border: 1px solid #e6e6e6;
        font-size: 0.9rem;
        line-height: 1.4;
    }

        .message-received .message-sender {
            font-weight: 600;
            color: #385898;
            font-size: 0.75rem;
            margin-bottom: 3px;
        }

    /* وقت الرسالة */
    .message-time {
        font-size: 0.65rem;
        opacity: 0.8;
        margin-top: 4px;
        display: block;
    }

    .message-sent .message-time {
        color: rgba(255,255,255,0.85);
    }

    .message-received .message-time {
        color: #65676b;
    }

    /* الرسائل النظامية */
    .message-system {
        align-self: center;
        background: rgba(0,0,0,0.04);
        color: #65676b;
        border-radius: 12px;
        padding: 6px 12px;
        font-size: 0.75rem;
        margin: 5px 0;
        text-align: center;
    }

    /* منطقة الكتابة */
    .chat-input {
        flex-shrink: 0;
        padding: 10px 12px !important;
        background: white;
        border-top: 1px solid #e4e6eb;
    }

    #msgInput {
        border-radius: 20px;
        border: 1px solid #dddfe2;
        padding: 8px 15px;
        font-size: 0.9rem;
        background: #f0f2f5;
    }

        #msgInput:focus {
            border-color: #0084ff;
            box-shadow: 0 0 0 2px rgba(0,132,255,0.2);
            background: white;
        }

    #btnSend {
        border-radius: 20px;
        margin-left: 8px;
        padding: 8px 20px;
        background: linear-gradient(135deg, #0084ff, #0073e6);
        border: none;
    }

        #btnSend:hover {
            background: linear-gradient(135deg, #0073e6, #0062cc);
        }

    /* عداد الأحرف */
    #charCount {
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* مؤشر الكتابة */
    #typingIndicator {
        font-size: 0.75rem;
        background: #f0f2f5;
        padding: 5px 10px;
        border-radius: 15px;
        margin: 5px 0;
        align-self: flex-start;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* الأنيميشن */
    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    @@keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    /* زر إنهاء المحادثة */
    #btnEndChat {
        font-size: 0.85rem;
        padding: 4px 10px;
        border: 1px solid rgba(255,255,255,0.3);
    }

        #btnEndChat:hover {
            background-color: rgba(255,255,255,0.15);
        }

    /* التمرير */
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

    /* تصميم للرسائل الطويلة */
    .long-message {
        max-height: 200px;
        overflow-y: auto;
        padding-right: 5px;
    }

    /* رسالة قيد الإرسال */
    .sending {
        opacity: 0.7;
        position: relative;
    }

        .sending::after {
            content: '';
            position: absolute;
            right: 5px;
            top: 50%;
            width: 4px;
            height: 4px;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            animation: sendingDots 1.4s infinite;
        }

    @@keyframes sendingDots {
        0%, 100% {
            opacity: 0.3;
        }

        50% {
            opacity: 1;
        }
    }

    /* تصميم للجوال */
    @@media (max-width: 768px) {
        .chat-container {
            margin: 0;
            border-radius: 0;
            height: 100vh;
            max-height: none;
            max-width: none;
        }

        .message-sent,
        .message-received {
            max-width: 85%;
        }
    }

    /* تحسين عرض النصوص العربية */
    .message-content {
        text-align: right;
        direction: rtl;
        word-break: break-word;
        white-space: pre-wrap;
    }

    /* أيقونة التأكيد */
    .fa-check-circle {
        margin-left: 5px;
        font-size: 0.6rem;
    }

    /* إخفاء تحذير الأحرف */
    #charLimitAlert {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 90%;
        max-width: 400px;
    }
</style>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
        // المتغيرات العامة
        const currentChatId = "@Model.Id";
        const currentUserId = "@userId";
        const currentUserName = "@userName";
        const MAX_CHARS = 500;
        let connection = null;
        let isTyping = false;
        let sentMessageIds = new Set(); // لتخزين معرفات الرسائل المرسلة
        let tempMessages = new Map(); // لتخزين الرسائل المؤقتة

        // التحقق من وجود userId
        if (!currentUserId) {
            alert('خطأ: لم يتم التعرف على المستخدم. يرجى تسجيل الدخول مرة أخرى.');
            window.location.href = '/Account/Login';
        }

        // تحديث عداد الأحرف
        function updateCharCount() {
            const input = document.getElementById('msgInput');
            const charCount = document.getElementById('charCount');
            if (!input || !charCount) return;

            const length = input.value.length;
            const remaining = MAX_CHARS - length;
            charCount.textContent = `${length}/${MAX_CHARS}`;

            // تغيير اللون بناءً على عدد الأحرف المتبقية
            charCount.classList.remove('warning', 'danger');
            input.classList.remove('warning', 'danger');

            if (remaining <= 100 && remaining > 50) {
                charCount.classList.add('warning');
                input.classList.add('warning');
            } else if (remaining <= 50 && remaining > 0) {
                charCount.classList.add('danger');
                input.classList.add('danger');
            } else if (remaining <= 0) {
                charCount.classList.add('danger');
                input.classList.add('danger');
            }
        }

        // عرض تحذير عند تجاوز الحد
        function showCharLimitWarning(message) {
            const alertDiv = document.getElementById('charLimitAlert');
            const alertMessage = document.getElementById('alertMessage');
            if (alertDiv && alertMessage) {
                alertMessage.textContent = message;
                alertDiv.style.display = 'block';

                // إخفاء التحذير بعد 5 ثواني
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 5000);
            }
        }

        // التحقق من طول الرسالة
        function validateMessage(message) {
            if (message.length > MAX_CHARS) {
                showCharLimitWarning(`تجاوزت الحد المسموح (${MAX_CHARS} حرف). الرجاء تقصير الرسالة.`);
                return false;
            }
            return true;
        }

        // تهيئة الاتصال بـ SignalR
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            return 2000;
                        }
                        return 5000;
                    }
                })
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            // استقبال الرسائل الجديدة - مع 4 معاملات (messageId هو الرابع)
            connection.on("ReceiveMessage", function (senderId, message, time, messageId = null) {
                const isMe = senderId === currentUserId;

                // إزالة رسالة "جاري الاتصال"
                const loadingDiv = document.querySelector('.text-center.text-muted');
                if (loadingDiv) loadingDiv.remove();

                // إذا كانت الرسالة مني ولها معرف، فهي نسخة من الخادم
                if (isMe && messageId) {
                    // تحديث الرسالة المؤقتة إذا وجدت
                    updateTempMessage(messageId, message, time);
                    hideTypingIndicator();
                    return;
                }

                // إذا كانت الرسالة مني ولا يوجد معرف، قد تكون تكراراً
                if (isMe && !messageId) {
                    // التحقق من وجود رسالة مشابهة حديثة
                    if (isDuplicateMessage(message, time)) {
                        console.log('تم تجاهل رسالة مكررة:', message);
                        hideTypingIndicator();
                        return;
                    }
                }

                // إذا كانت الرسالة من شخص آخر، إضافتها مباشرة
                if (!isMe) {
                    addMessageToChat(message, false, time, senderId, messageId);
                    hideTypingIndicator();
                    return;
                }

                // إضافة الرسالة الجديدة (إذا مرت جميع الشروط)
                addMessageToChat(message, isMe, time, senderId, messageId);
                hideTypingIndicator();
            });

            // مؤشر كتابة المستخدم الآخر
            connection.on("UserTyping", function (chatId, userId) {
                if (chatId === currentChatId && userId !== currentUserId) {
                    showTypingIndicator();
                }
            });

            // أحداث الاتصال
            connection.onreconnecting(error => {
                console.log('إعادة الاتصال...', error);
                updateConnectionStatus('disconnected', 'إعادة الاتصال...');
            });

            connection.onreconnected(connectionId => {
                console.log('تم إعادة الاتصال');
                updateConnectionStatus('connected', 'متصل');

                // الانضمام للمحادثة مرة أخرى
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("JoinChat", currentChatId)
                        .catch(err => console.error('خطأ في الانضمام للمحادثة:', err));
                }
            });

            connection.onclose(error => {
                console.log('تم إغلاق الاتصال', error);
                updateConnectionStatus('disconnected', 'انقطع الاتصال');
            });

            // بدء الاتصال
            connection.start()
                .then(() => {
                    console.log("✅ متصل بـ SignalR");
                    updateConnectionStatus('connected', 'متصل');

                    // الانضمام للمحادثة
                    return connection.invoke("JoinChat", currentChatId);
                })
                .then(() => {
                    console.log("✅ انضم للمحادثة: " + currentChatId);

                    // إرسال رسالة دخول
                    addSystemMessage('تم الاتصال بالدعم، يمكنك البدء في المحادثة');
                })
                .catch(err => {
                    console.error("❌ خطأ في الاتصال: ", err);
                    updateConnectionStatus('disconnected', 'انقطع الاتصال');
                    addSystemMessage('تعذر الاتصال بالخادم، يرجى تحديث الصفحة');
                });
        }

        // التحقق مما إذا كانت الرسالة مكررة
        function isDuplicateMessage(message, time) {
            // البحث عن رسائل حديثة (في آخر 5 ثواني) لها نفس المحتوى
            const sentMessages = document.querySelectorAll('.message-sent:not(.sending)');
            const now = new Date();
            const currentTime = now.getTime();

            for (let msg of sentMessages) {
                const content = msg.querySelector('.message-content').textContent;
                const msgTimeText = msg.querySelector('.message-time').textContent;

                // إذا كانت الرسالة مطابقة في المحتوى وكانت حديثة
                if (content === message) {
                    const msgTime = parseMessageTime(msgTimeText);
                    const newTime = parseMessageTime(time);

                    // إذا كان الفرق أقل من 5 ثواني، تعتبر مكررة
                    if (Math.abs(msgTime - newTime) < 5000) {
                        return true;
                    }
                }
            }
            return false;
        }

        // تحويل وقت الرسالة إلى timestamp
        function parseMessageTime(timeStr) {
            const now = new Date();
            const [hours, minutes] = timeStr.split(':').map(Number);
            const messageTime = new Date(now);
            messageTime.setHours(hours, minutes, 0, 0);

            // إذا كان الوقت بعد منتصف الليل ولكن الآن قبل الظهر، فهو من اليوم السابق
            if (messageTime > now && messageTime - now > 12 * 60 * 60 * 1000) {
                messageTime.setDate(messageTime.getDate() - 1);
            }

            return messageTime.getTime();
        }

        // تحديث الرسالة المؤقتة بعد استلامها من الخادم
        function updateTempMessage(messageId, message, time) {
            // البحث في جميع الرسائل المؤقتة
            for (let [tempId, tempData] of tempMessages.entries()) {
                if (tempData.message === message) {
                    const tempElement = document.querySelector(`[data-temp-id="${tempId}"]`);
                    if (tempElement) {
                        // تحديث المعرف
                        tempElement.setAttribute('data-message-id', messageId);
                        tempElement.removeAttribute('data-temp-id');

                        // تحديث الوقت
                        const timeSpan = tempElement.querySelector('.message-time');
                        if (timeSpan && time) {
                            timeSpan.textContent = time;
                        }

                        // تغيير الحالة من قيد الإرسال إلى تم الإرسال
                        tempElement.classList.remove('sending');
                        tempElement.classList.add('sent-confirmed');

                        // إضافة أيقونة التأكيد
                        const checkIcon = document.createElement('i');
                        checkIcon.className = 'fas fa-check-circle';
                        timeSpan.appendChild(checkIcon);

                        // تخزين معرف الرسالة لمنع التكرار
                        sentMessageIds.add(messageId);

                        // إزالة من القائمة المؤقتة
                        tempMessages.delete(tempId);
                        break;
                    }
                }
            }
        }

        // إضافة رسالة للدردشة مع معالجة النصوص الطويلة
        function addMessageToChat(message, isSent, time = null, senderId = null, messageId = null) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            const messageDiv = document.createElement('div');

            const now = new Date();
            const displayTime = time || now.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // تحضير محتوى الرسالة
            const messageContent = escapeHtml(message);
            const isLongMessage = message.length > 200;

            if (isSent) {
                messageDiv.className = 'message-sent';

                // إذا كانت رسالة طويلة، أضف كلاس خاص
                if (isLongMessage) {
                    messageDiv.classList.add('long-message');
                }

                // إذا كانت رسالة جديدة بدون معرف، فهي مؤقتة
                if (!messageId) {
                    const tempId = 'temp_' + Date.now();
                    messageDiv.setAttribute('data-temp-id', tempId);
                    messageDiv.classList.add('sending');

                    // تخزين الرسالة المؤقتة
                    tempMessages.set(tempId, {
                        message: message,
                        time: displayTime
                    });
                } else {
                    messageDiv.setAttribute('data-message-id', messageId);
                    sentMessageIds.add(messageId);
                }

                messageDiv.innerHTML = `
                    <div class="message-content ${isLongMessage ? 'multi-line-message' : ''}">${messageContent}</div>
                    <span class="message-time">${displayTime}</span>
                `;
            } else {
                messageDiv.className = 'message-received';

                // إذا كانت رسالة طويلة، أضف كلاس خاص
                if (isLongMessage) {
                    messageDiv.classList.add('long-message');
                }

                if (messageId) {
                    messageDiv.setAttribute('data-message-id', messageId);
                }
                const senderName = (senderId === currentUserId) ? 'أنت' : 'الدعم';
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderName}</div>
                    <div class="message-content ${isLongMessage ? 'multi-line-message' : ''}">${messageContent}</div>
                    <span class="message-time">${displayTime}</span>
                `;
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // إضافة رسالة نظامية
        function addSystemMessage(text) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-system';
            messageDiv.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${escapeHtml(text)}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = text;
                statusElement.className = status;
            }
        }

        // إرسال رسالة
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const message = input.value.trim();

            if (!message) {
                showCharLimitWarning('الرجاء كتابة رسالة قبل الإرسال');
                return;
            }

            // التحقق من طول الرسالة
            if (!validateMessage(message)) {
                return;
            }

            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert('الاتصال غير نشط. يرجى الانتظار...');
                return;
            }

            // مسح حقل الإدخال
            input.value = '';
            updateCharCount(); // تحديث العداد بعد المسح

            // إضافة الرسالة المحلية فوراً (بعلامة قيد الإرسال)
            addMessageToChat(message, true, null, currentUserId);

            // إرسال الرسالة للخادم
            connection.invoke("SendMessage", currentChatId, message)
                .then(() => {
                    // النجاح معالج في حدث ReceiveMessage
                    console.log('تم إرسال الرسالة للخادم');
                })
                .catch(err => {
                    console.error("❌ فشل إرسال الرسالة: ", err);

                    // البحث عن الرسالة المؤقتة الأخيرة وتحديث حالتها إلى فاشلة
                    const tempMessagesArray = Array.from(tempMessages.entries());
                    if (tempMessagesArray.length > 0) {
                        const [lastTempId, lastTempData] = tempMessagesArray[tempMessagesArray.length - 1];

                        if (lastTempData.message === message) {
                            const tempMsg = document.querySelector(`[data-temp-id="${lastTempId}"]`);
                            if (tempMsg) {
                                tempMsg.classList.remove('sending');
                                tempMsg.classList.add('send-failed');

                                const timeSpan = tempMsg.querySelector('.message-time');
                                if (timeSpan) {
                                    const warningIcon = document.createElement('i');
                                    warningIcon.className = 'fas fa-exclamation-triangle';
                                    warningIcon.title = 'فشل الإرسال';
                                    timeSpan.appendChild(warningIcon);
                                }

                                // إزالة من القائمة المؤقتة
                                tempMessages.delete(lastTempId);
                            }
                        }
                    }

                    addSystemMessage('فشل إرسال الرسالة، جاري إعادة المحاولة...');

                    // محاولة إعادة الإرسال بعد 3 ثواني
                    setTimeout(() => {
                        if (connection && connection.state === signalR.HubConnectionState.Connected) {
                            retrySendMessage(message);
                        }
                    }, 3000);
                });
        }

        // إعادة محاولة إرسال الرسالة
        function retrySendMessage(message) {
            // التحقق من طول الرسالة مرة أخرى
            if (!validateMessage(message)) {
                return;
            }

            // إرسال الرسالة مرة أخرى
            connection.invoke("SendMessage", currentChatId, message)
                .then(() => {
                    console.log('تمت إعادة إرسال الرسالة بنجاح');
                })
                .catch(err => {
                    console.error("❌ فشل إعادة إرسال الرسالة: ", err);
                });
        }

        // إنهاء المحادثة
        function endChat() {
            if (confirm('هل أنت متأكد من إنهاء المحادثة؟ سيتم إغلاق النافذة.')) {
                if (connection) {
                    connection.invoke("LeaveChat", currentChatId)
                        .then(() => {
                            connection.stop();
                            window.location.href = '/Home';
                        })
                        .catch(err => {
                            console.error('خطأ في إنهاء المحادثة:', err);
                            window.location.href = '/Home';
                        });
                } else {
                    window.location.href = '/Home';
                }
            }
        }

        // التهريب من HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // الكشف عن الكتابة
        function detectTyping() {
            if (!isTyping && connection && connection.state === signalR.HubConnectionState.Connected) {
                isTyping = true;
                connection.invoke("NotifyTyping", currentChatId, currentUserId)
                    .catch(err => console.error('خطأ في إرسال إشعار الكتابة:', err));

                setTimeout(() => {
                    isTyping = false;
                }, 1000);
            }
        }

        // عرض مؤشر الكتابة
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';

                // إخفاء المؤشر بعد 3 ثواني
                setTimeout(() => {
                    hideTypingIndicator();
                }, 3000);
            }
        }

        // إخفاء مؤشر الكتابة
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // الكشف عن إغلاق الصفحة
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    // استخدام sendBeacon لإرسال طلب الخروج حتى مع إغلاق الصفحة
                    navigator.sendBeacon(`/UserChat/Leave?chatId=${currentChatId}`);
                }
            });
        }

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من صحة البيانات
            if (!currentUserId || currentUserId === '') {
                alert('خطأ: لم يتم التعرف على المستخدم');
                window.location.href = '/Account/Login';
                return;
            }

            if (!currentChatId || currentChatId === '0') {
                alert('خطأ: لم يتم إنشاء محادثة');
                window.location.href = '/UserChat';
                return;
            }

            // تهيئة الاتصال
            initializeConnection();

            // إعداد الأحداث
            const btnSend = document.getElementById('btnSend');
            const btnEndChat = document.getElementById('btnEndChat');
            const msgInput = document.getElementById('msgInput');

            if (btnSend) btnSend.addEventListener('click', sendMessage);
            if (btnEndChat) btnEndChat.addEventListener('click', endChat);

            if (msgInput) {
                // تحديث عداد الأحرف عند الكتابة
                msgInput.addEventListener('input', function() {
                    updateCharCount();
                    detectTyping();
                });

                msgInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // التحقق من الحد عند اللصق
                msgInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        const text = msgInput.value;
                        if (text.length > MAX_CHARS) {
                            msgInput.value = text.substring(0, MAX_CHARS);
                            showCharLimitWarning(`تم تقليم الرسالة إلى ${MAX_CHARS} حرف`);
                        }
                        updateCharCount();
                    }, 0);
                });
            }

            // إعداد حدث إغلاق الصفحة
            setupBeforeUnload();

            // التركيز على حقل الإدخال
            setTimeout(() => {
                if (msgInput) msgInput.focus();
            }, 500);
        });
    </script>
}