@using System.Security.Claims
@model Chat.Core.Entities.ChatSession

@{
    Layout = "_Layout";
    ViewData["Title"] = "الدعم المباشر";

    // استخدام الطريقة الصحيحة للحصول على userId
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var userName = User.Identity?.Name ?? "مستخدم";

    // التحقق من القيم
    bool isClosed = ViewBag.IsClosed != null && (bool)ViewBag.IsClosed;
}

<div class="chat-container">
    <!-- شريط معلومات الدردشة -->
    <div class="chat-header bg-primary text-white p-3 rounded-top">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-headset fa-lg me-3"></i>
                <div>
                    <h4 class="mb-0">الدعم المباشر</h4>
                    <small id="connectionStatus" class="d-block">جاري الاتصال...</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark">
                    <i class="fas fa-hashtag"></i> @Model.Id
                </span>
                <button id="btnEndChat" class="btn btn-sm btn-outline-light" title="إنهاء المحادثة">
                    <i class="fas fa-times me-1"></i> إنهاء
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة المحادثة -->
    <div id="chatBox" class="chat-messages p-3">
        <!-- الرسائل ستظهر هنا ديناميكيًا -->
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin me-2"></i> جاري الاتصال بالدعم...
        </div>
    </div>

    <!-- منطقة الكتابة -->
    <div class="chat-input p-3 border-top">
        <div class="input-group">
            <input type="text" id="msgInput" class="form-control"
                   placeholder="اكتب رسالتك هنا..." autocomplete="off"
                   @(isClosed ? "disabled" : "")>
            <button id="btnSend" class="btn btn-primary" @(isClosed ? "disabled" : "")>
                <i class="fas fa-paper-plane"></i> إرسال
            </button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <small class="text-muted">
                <i class="fas fa-user me-1"></i> أنت: @userName
            </small>
            <small id="typingIndicator" class="text-muted" style="display:none;">
                <i class="fas fa-pencil-alt me-1"></i> الدعم يكتب...
            </small>
        </div>
    </div>
</div>


    <style>
        .chat-container {
            max-width: 900px;
            margin: 2rem auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            background: white;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px !important;
        }

        /* رسائل المرسل */
        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            max-width: 75%;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .message-sent .message-time {
                color: rgba(255,255,255,0.8);
                text-align: left;
            }

        /* رسائل المستقبل */
        .message-received {
            align-self: flex-start;
            background: white;
            color: #333;
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            max-width: 75%;
            animation: slideInLeft 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

            .message-received .message-sender {
                font-weight: bold;
                color: #007bff;
                font-size: 0.85rem;
                margin-bottom: 4px;
            }

            .message-received .message-time {
                color: #6c757d;
                text-align: right;
            }

        /* الرسائل النظامية */
        .message-system {
            align-self: center;
            background: #e9ecef;
            color: #6c757d;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 0.85rem;
            max-width: 90%;
            text-align: center;
            margin: 10px 0;
        }

        /* وقت الرسالة */
        .message-time {
            display: block;
            font-size: 0.7rem;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* منطقة الكتابة */
        .chat-input {
            background: white;
        }

        #msgInput {
            border-radius: 25px 0 0 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            transition: all 0.3s;
        }

            #msgInput:focus {
                border-color: #007bff;
                box-shadow: 0 0 0 0.25rem rgba(0,123,255,0.25);
            }

        #btnSend {
            border-radius: 0 25px 25px 0;
            padding: 12px 25px;
        }

        /* مؤشر الكتابة */
        #typingIndicator {
            animation: pulse 1.5s infinite;
        }

        /* الأنيميشن */
        @@keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @@keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* مخصص لعرض حالة الاتصال */
        #connectionStatus.connected {
            color: #28a745;
        }

        #connectionStatus.disconnected {
            color: #dc3545;
        }

        /* تصميم زر إنهاء المحادثة */
        #btnEndChat:hover {
            background-color: rgba(255,255,255,0.2);
        }

        /* رسالة قيد الإرسال */
        .sending {
            opacity: 0.7;
            border-right: 3px solid #ffc107 !important;
        }

        /* رسالة تم إرسالها */
        .sent-confirmed {
            border-right: 3px solid #28a745 !important;
        }

        /* رسالة فشل إرسالها */
        .send-failed {
            border-right: 3px solid #dc3545 !important;
            opacity: 0.8;
        }

        /* أيقونة التأكيد */
        .fa-check-circle {
            color: #28a745;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* أيقونة التحذير */
        .fa-exclamation-triangle {
            color: #ffc107;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        /* التمرير */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

            .chat-messages::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

        /* تصميم للجوال */
        @@media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
            }

            .chat-messages {
                height: calc(100vh - 180px);
            }

            .message-sent,
            .message-received {
                max-width: 85%;
            }
        }
    </style>

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script>
        // المتغيرات العامة
        const currentChatId = "@Model.Id";
        const currentUserId = "@userId";
        const currentUserName = "@userName";
        let connection = null;
        let isTyping = false;
        let sentMessageIds = new Set(); // لتخزين معرفات الرسائل المرسلة
        let tempMessages = new Map(); // لتخزين الرسائل المؤقتة

        // التحقق من وجود userId
        if (!currentUserId) {
            alert('خطأ: لم يتم التعرف على المستخدم. يرجى تسجيل الدخول مرة أخرى.');
            window.location.href = '/Account/Login';
        }

        // تهيئة الاتصال بـ SignalR
        function initializeConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            return 2000;
                        }
                        return 5000;
                    }
                })
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            // استقبال الرسائل الجديدة - مع 4 معاملات (messageId هو الرابع)
            connection.on("ReceiveMessage", function (senderId, message, time, messageId = null) {
                const isMe = senderId === currentUserId;

                // إزالة رسالة "جاري الاتصال"
                const loadingDiv = document.querySelector('.text-center.text-muted');
                if (loadingDiv) loadingDiv.remove();

                // إذا كانت الرسالة مني ولها معرف، فهي نسخة من الخادم
                if (isMe && messageId) {
                    // تحديث الرسالة المؤقتة إذا وجدت
                    updateTempMessage(messageId, message, time);
                    hideTypingIndicator();
                    return;
                }

                // إذا كانت الرسالة مني ولا يوجد معرف، قد تكون تكراراً
                if (isMe && !messageId) {
                    // التحقق من وجود رسالة مشابهة حديثة
                    if (isDuplicateMessage(message, time)) {
                        console.log('تم تجاهل رسالة مكررة:', message);
                        hideTypingIndicator();
                        return;
                    }
                }

                // إذا كانت الرسالة من شخص آخر، إضافتها مباشرة
                if (!isMe) {
                    addMessageToChat(message, false, time, senderId, messageId);
                    hideTypingIndicator();
                    return;
                }

                // إضافة الرسالة الجديدة (إذا مرت جميع الشروط)
                addMessageToChat(message, isMe, time, senderId, messageId);
                hideTypingIndicator();
            });

            // مؤشر كتابة المستخدم الآخر
            connection.on("UserTyping", function (chatId, userId) {
                if (chatId === currentChatId && userId !== currentUserId) {
                    showTypingIndicator();
                }
            });

            // أحداث الاتصال
            connection.onreconnecting(error => {
                console.log('إعادة الاتصال...', error);
                updateConnectionStatus('disconnected', 'إعادة الاتصال...');
            });

            connection.onreconnected(connectionId => {
                console.log('تم إعادة الاتصال');
                updateConnectionStatus('connected', 'متصل');

                // الانضمام للمحادثة مرة أخرى
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("JoinChat", currentChatId)
                        .catch(err => console.error('خطأ في الانضمام للمحادثة:', err));
                }
            });

            connection.onclose(error => {
                console.log('تم إغلاق الاتصال', error);
                updateConnectionStatus('disconnected', 'انقطع الاتصال');
            });

            // بدء الاتصال
            connection.start()
                .then(() => {
                    console.log("✅ متصل بـ SignalR");
                    updateConnectionStatus('connected', 'متصل');

                    // الانضمام للمحادثة
                    return connection.invoke("JoinChat", currentChatId);
                })
                .then(() => {
                    console.log("✅ انضم للمحادثة: " + currentChatId);

                    // إرسال رسالة دخول
                    addSystemMessage('تم الاتصال بالدعم، يمكنك البدء في المحادثة');
                })
                .catch(err => {
                    console.error("❌ خطأ في الاتصال: ", err);
                    updateConnectionStatus('disconnected', 'انقطع الاتصال');
                    addSystemMessage('تعذر الاتصال بالخادم، يرجى تحديث الصفحة');
                });
        }

        // التحقق مما إذا كانت الرسالة مكررة
        function isDuplicateMessage(message, time) {
            // البحث عن رسائل حديثة (في آخر 5 ثواني) لها نفس المحتوى
            const sentMessages = document.querySelectorAll('.message-sent:not(.sending)');
            const now = new Date();
            const currentTime = now.getTime();

            for (let msg of sentMessages) {
                const content = msg.querySelector('.message-content').textContent;
                const msgTimeText = msg.querySelector('.message-time').textContent;

                // إذا كانت الرسالة مطابقة في المحتوى وكانت حديثة
                if (content === message) {
                    const msgTime = parseMessageTime(msgTimeText);
                    const newTime = parseMessageTime(time);

                    // إذا كان الفرق أقل من 5 ثواني، تعتبر مكررة
                    if (Math.abs(msgTime - newTime) < 5000) {
                        return true;
                    }
                }
            }
            return false;
        }

        // تحويل وقت الرسالة إلى timestamp
        function parseMessageTime(timeStr) {
            const now = new Date();
            const [hours, minutes] = timeStr.split(':').map(Number);
            const messageTime = new Date(now);
            messageTime.setHours(hours, minutes, 0, 0);

            // إذا كان الوقت بعد منتصف الليل ولكن الآن قبل الظهر، فهو من اليوم السابق
            if (messageTime > now && messageTime - now > 12 * 60 * 60 * 1000) {
                messageTime.setDate(messageTime.getDate() - 1);
            }

            return messageTime.getTime();
        }

        // تحديث الرسالة المؤقتة بعد استلامها من الخادم
        function updateTempMessage(messageId, message, time) {
            // البحث في جميع الرسائل المؤقتة
            for (let [tempId, tempData] of tempMessages) {
                if (tempData.message === message) {
                    const tempElement = document.querySelector(`[data-temp-id="${tempId}"]`);
                    if (tempElement) {
                        // تحديث المعرف
                        tempElement.setAttribute('data-message-id', messageId);
                        tempElement.removeAttribute('data-temp-id');

                        // تحديث الوقت
                        const timeSpan = tempElement.querySelector('.message-time');
                        if (timeSpan && time) {
                            timeSpan.textContent = time;
                        }

                        // تغيير الحالة من قيد الإرسال إلى تم الإرسال
                        tempElement.classList.remove('sending');
                        tempElement.classList.add('sent-confirmed');

                        // إضافة أيقونة التأكيد
                        const checkIcon = document.createElement('i');
                        checkIcon.className = 'fas fa-check-circle';
                        timeSpan.appendChild(checkIcon);

                        // تخزين معرف الرسالة لمنع التكرار
                        sentMessageIds.add(messageId);

                        // إزالة من القائمة المؤقتة
                        tempMessages.delete(tempId);
                        break;
                    }
                }
            }
        }

        // إضافة رسالة للدردشة
        function addMessageToChat(message, isSent, time = null, senderId = null, messageId = null) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            const messageDiv = document.createElement('div');

            const now = new Date();
            const displayTime = time || now.toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (isSent) {
                messageDiv.className = 'message-sent';

                // إذا كانت رسالة جديدة بدون معرف، فهي مؤقتة
                if (!messageId) {
                    const tempId = 'temp_' + Date.now();
                    messageDiv.setAttribute('data-temp-id', tempId);
                    messageDiv.classList.add('sending');

                    // تخزين الرسالة المؤقتة
                    tempMessages.set(tempId, {
                        message: message,
                        time: displayTime
                    });
                } else {
                    messageDiv.setAttribute('data-message-id', messageId);
                    sentMessageIds.add(messageId);
                }

                messageDiv.innerHTML = `
                    <div class="message-content">${escapeHtml(message)}</div>
                    <span class="message-time">${displayTime}</span>
                `;
            } else {
                messageDiv.className = 'message-received';
                if (messageId) {
                    messageDiv.setAttribute('data-message-id', messageId);
                }
                const senderName = (senderId === currentUserId) ? 'أنت' : 'الدعم';
                messageDiv.innerHTML = `
                    <div class="message-sender">${senderName}</div>
                    <div class="message-content">${escapeHtml(message)}</div>
                    <span class="message-time">${displayTime}</span>
                `;
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // إضافة رسالة نظامية
        function addSystemMessage(text) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-system';
            messageDiv.innerHTML = `<i class="fas fa-info-circle me-1"></i> ${text}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.textContent = text;
                statusElement.className = status;
            }
        }

        // إرسال رسالة
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const message = input.value.trim();

            if (!message) return;
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert('الاتصال غير نشط. يرجى الانتظار...');
                return;
            }

            // مسح حقل الإدخال أولاً
            input.value = '';

            // إضافة الرسالة المحلية فوراً (بعلامة قيد الإرسال)
            addMessageToChat(message, true, null, currentUserId);

            // إرسال الرسالة للخادم
            connection.invoke("SendMessage", currentChatId, message)
                .then(() => {
                    // النجاح معالج في حدث ReceiveMessage
                    console.log('تم إرسال الرسالة للخادم');
                })
                .catch(err => {
                    console.error("❌ فشل إرسال الرسالة: ", err);

                    // البحث عن الرسالة المؤقتة الأخيرة وتحديث حالتها إلى فاشلة
                    const tempMessagesArray = Array.from(tempMessages.entries());
                    if (tempMessagesArray.length > 0) {
                        const [lastTempId, lastTempData] = tempMessagesArray[tempMessagesArray.length - 1];

                        if (lastTempData.message === message) {
                            const tempMsg = document.querySelector(`[data-temp-id="${lastTempId}"]`);
                            if (tempMsg) {
                                tempMsg.classList.remove('sending');
                                tempMsg.classList.add('send-failed');

                                const timeSpan = tempMsg.querySelector('.message-time');
                                if (timeSpan) {
                                    const warningIcon = document.createElement('i');
                                    warningIcon.className = 'fas fa-exclamation-triangle';
                                    warningIcon.title = 'فشل الإرسال';
                                    timeSpan.appendChild(warningIcon);
                                }

                                // إزالة من القائمة المؤقتة
                                tempMessages.delete(lastTempId);
                            }
                        }
                    }

                    addSystemMessage('فشل إرسال الرسالة، جاري إعادة المحاولة...');

                    // محاولة إعادة الإرسال بعد 3 ثواني
                    setTimeout(() => {
                        if (connection && connection.state === signalR.HubConnectionState.Connected) {
                            retrySendMessage(message);
                        }
                    }, 3000);
                });
        }

        // إعادة محاولة إرسال الرسالة
        function retrySendMessage(message) {
            // إرسال الرسالة مرة أخرى
            connection.invoke("SendMessage", currentChatId, message)
                .then(() => {
                    console.log('تمت إعادة إرسال الرسالة بنجاح');
                })
                .catch(err => {
                    console.error("❌ فشل إعادة إرسال الرسالة: ", err);
                });
        }

        // إنهاء المحادثة
        function endChat() {
            if (confirm('هل أنت متأكد من إنهاء المحادثة؟ سيتم إغلاق النافذة.')) {
                if (connection) {
                    connection.invoke("LeaveChat", currentChatId)
                        .then(() => {
                            connection.stop();
                            window.location.href = '/Home';
                        })
                        .catch(err => {
                            console.error('خطأ في إنهاء المحادثة:', err);
                            window.location.href = '/Home';
                        });
                } else {
                            window.location.href = '/Home';
                }
            }
        }

        // التهريب من HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // الكشف عن الكتابة
        function detectTyping() {
            if (!isTyping && connection && connection.state === signalR.HubConnectionState.Connected) {
                isTyping = true;
                connection.invoke("NotifyTyping", currentChatId, currentUserId)
                    .catch(err => console.error('خطأ في إرسال إشعار الكتابة:', err));

                setTimeout(() => {
                    isTyping = false;
                }, 1000);
            }
        }

        // عرض مؤشر الكتابة
        function showTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'block';

                // إخفاء المؤشر بعد 3 ثواني
                setTimeout(() => {
                    hideTypingIndicator();
                }, 3000);
            }
        }

        // إخفاء مؤشر الكتابة
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }
        }

        // الكشف عن إغلاق الصفحة
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    // استخدام sendBeacon لإرسال طلب الخروج حتى مع إغلاق الصفحة
                    navigator.sendBeacon(`/UserChat/Leave?chatId=${currentChatId}`);
                }
            });
        }

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من صحة البيانات
            if (!currentUserId || currentUserId === '') {
                alert('خطأ: لم يتم التعرف على المستخدم');
                window.location.href = '/Account/Login';
                return;
            }

            if (!currentChatId || currentChatId === '0') {
                alert('خطأ: لم يتم إنشاء محادثة');
                window.location.href = '/UserChat';
                return;
            }

            // تهيئة الاتصال
            initializeConnection();

            // إعداد الأحداث
            const btnSend = document.getElementById('btnSend');
            const btnEndChat = document.getElementById('btnEndChat');
            const msgInput = document.getElementById('msgInput');

            if (btnSend) btnSend.addEventListener('click', sendMessage);
            if (btnEndChat) btnEndChat.addEventListener('click', endChat);

            if (msgInput) {
                msgInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // الكشف عن الكتابة عند الكتابة
                msgInput.addEventListener('input', detectTyping);
            }

            // إعداد حدث إغلاق الصفحة
            setupBeforeUnload();

            // التركيز على حقل الإدخال
            setTimeout(() => {
                if (msgInput) msgInput.focus();
            }, 500);
        });
    </script>
}