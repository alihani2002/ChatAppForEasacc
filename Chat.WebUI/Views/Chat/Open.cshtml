@model Chat.Application.ChatSessionDetailsVM
@using System.Security.Claims

@{
    Layout = "_Layout";
    ViewData["Title"] = "محادثة الدعم";
    var adminId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    var isClosed = Model.IsClosed;
}

<div class="admin-chat-container">
    <!-- رأس المحادثة -->
    <div class="admin-chat-header">
        <div class="header-content">
            <div class="user-info">
                <div class="avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="info">
                    <h4 class="mb-1">محادثة الدعم</h4>
                    <div class="details">
                        <span class="detail-item">
                            <i class="fas fa-user"></i>
                            <span>ID: @Model.UserId</span>
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <span>@Model.CreatedOn.ToString("yyyy/MM/dd HH:mm")</span>
                        </span>
                        <span class="detail-item status">
                            <i class="fas fa-circle @(isClosed ? "closed" : "active")"></i>
                            <span>@(isClosed ? "مغلقة" : "نشطة")</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <span class="chat-id">
                    <i class="fas fa-hashtag"></i>
                    <span>@Model.SessionId</span>
                </span>
                <button id="btnCloseChat" class="btn-action" title="إغلاق المحادثة" @(isClosed ? "disabled" : "")>
                    <i class="fas fa-lock"></i>
                    <span>إغلاق</span>
                </button>
                <a href="/Chat/" class="btn-action back-btn">
                    <i class="fas fa-arrow-right"></i>
                    <span>العودة</span>
                </a>
            </div>
        </div>

        <!-- مؤشر الكتابة -->
        <div id="typingIndicator" class="typing-indicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text"></span>
        </div>
    </div>

    <!-- نافذة المحادثة -->
    <div id="chatBox" class="admin-chat-messages">
        @if (!Model.Messages.Any())
        {
            <div class="empty-chat">
                <div class="empty-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h5>لا توجد رسائل بعد</h5>
                <p>ابدأ المحادثة مع المستخدم</p>
            </div>
        }
        else
        {
            @foreach (var msg in Model.Messages)
            {
                var isAdmin = msg.SenderId == adminId;
                <div class="message-wrapper @(isAdmin ? "message-sent" : "message-received")" data-message-id="@msg.Id" data-message-type="@((int)msg.MessageType)">
                    @if (msg.MessageType == Chat.Core.Enums.MessageType.Text)
                    {
                        <div class="message-content">
                            <div class="message-text">@(msg.Content ?? "")</div>
                            <div class="message-meta">
                                <span class="message-time">@msg.CreatedOn.ToString("HH:mm")</span>
                                @if (isAdmin)
                                {
                                    <span class="message-status">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="message-content">
                            @if (msg.MessageType == Chat.Core.Enums.MessageType.Image)
                            {
                                <img src="@msg.FileUrl" alt="@msg.FileName" class="chat-image" onclick="window.open('@msg.FileUrl', '_blank')" />
                            }
                            else if (msg.MessageType == Chat.Core.Enums.MessageType.Video)
                            {
                                <video controls class="chat-video">
                                    <source src="@msg.FileUrl" type="video/mp4">
                                    @msg.FileName
                                </video>
                            }
                            else if (msg.MessageType == Chat.Core.Enums.MessageType.Voice)
                            {
                                <audio controls class="chat-audio">
                                    <source src="@msg.FileUrl" type="audio/mpeg">
                                    @msg.FileName
                                </audio>
                            }
                            else
                            {
                                <a href="@msg.FileUrl" target="_blank" class="chat-file" download="@msg.FileName">
                                    <i class="fas fa-file-alt"></i>
                                    @msg.FileName
                                </a>
                            }
                            <div class="message-meta">
                                <span class="message-time">@msg.CreatedOn.ToString("HH:mm")</span>
                                @if (isAdmin)
                                {
                                    <span class="message-status">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>

    <!-- ملفات تم رفعها مسبقاً -->
    <div id="uploadedFiles" class="uploaded-files-container"></div>

    <!-- منطقة الرد -->
    <div class="admin-chat-input">
        <div class="input-wrapper">
            <div class="textarea-container">
                <textarea id="msgInput"
                          class="message-input"
                          placeholder="اكتب ردك هنا..."
                          rows="2"
                          maxlength="1000"
                          @(isClosed ? "disabled" : "")></textarea>
                <div class="input-tools">
                    <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" style="display: none;">
                    <button type="button" id="btnAttachment" class="tool-btn" title="إرفاق ملف" @(isClosed ? "disabled" : "")>
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button type="button" id="btnImage" class="tool-btn" title="صورة" @(isClosed ? "disabled" : "")>
                        <i class="fas fa-image"></i>
                    </button>
                    <button type="button" id="btnVoice" class="tool-btn" title="تسجيل صوتي" @(isClosed ? "disabled" : "")>
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>
            <button id="btnSend" class="send-btn" @(isClosed ? "disabled" : "")>
                <i class="fas fa-paper-plane"></i>
                <span>إرسال</span>
            </button>
        </div>
        <div class="input-footer">
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <small id="connectionStatus">@(isClosed ? "المحادثة مغلقة" : "جاري الاتصال...")</small>
            </div>
            <div class="input-hints">
                <small class="hint">Shift+Enter للسطر الجديد</small>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="~/css/views/chat/open.css" />

@section Scripts {
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/views/chat/open.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initChatOpen("@Model.SessionId", "@adminId", "@Model.UserId", @(isClosed ? "true" : "false"));
        });
    </script>
}